#' @title plot.PC.scatter
#'
#' @description Plot a scatter of the PCs from an object generated by \link{perform.PCA}.
#'
#' @param DEprot.PCA.object An object of class \code{DEprot.PCA.object}, as generated by \link{perform.PCA}.
#' @param PC.x Number indicating which Principal Component (PC) display on the x-axis. Default: \code{2} (PC2).
#' @param PC.y Number indicating which Principal Component (PC) display on the y-axis. Default: \code{1} (PC1).
#' @param color.column String indicating the name of the column in the \code{metadata} to use as factor for the dot colors. Default: \code{"column.id"} (each sample a color).
#' @param shape.column String indicating the name of the column in the \code{metadata} to use as factor for the dot shapes. Default: \code{NULL} (all dots).
#' @param label.column String indicating the name of the column in the \code{metadata} to use as label of the dots. Default: \code{NULL} (no labeling).
#' @param plot.zero.lines Logical value to indicate whether to plot two gray dashed lines in correspondence of y=0 and x=0. Default: \code{TRUE}.
#'
#' @return A ggplot object.
#'
#' @seealso \link{perform.PCA}
#'
#' @name plot.PC.scatter
#'
#' @export plot.PC.scatter

plot.PC.scatter =
  function(DEprot.PCA.object,
           PC.x = 2,
           PC.y = 1,
           color.column = "column.id",
           shape.column = NULL,
           label.column = NULL,
           plot.zero.lines = TRUE) {


    ### Libraries
    require(ggplot2)


    ### check object
    if (!("DEprot.PCA" %in% class(DEprot.PCA.object))) {
      return(warning("The input must be an object of class 'DEprot.PCA'."))
    }


    ### check feature/aes column
    if (!(color.column %in% colnames(DEprot.PCA.object@PCs))) {
      return(warning(paste0("The color column '", color.column, "' is not present in the PC analyses table.\n",
                            "Available columns: ", paste0(colnames(DEprot.PCA.object@PCs)[!grepl("^PC", colnames(DEprot.PCA.object@PCs))],
                                                          collapse = ", "))))
    }


    if (!is.null(shape.column)) {
      if (!(shape.column %in% colnames(DEprot.PCA.object@PCs))) {
        return(warning(paste0("The shape column '", shape.column, "' is not present in the PC analyses table.\n",
                              "Available columns: ", paste0(colnames(DEprot.PCA.object@PCs)[!grepl("^PC", colnames(DEprot.PCA.object@PCs))],
                                                            collapse = ", "))))
      } else {
        shape.scores = DEprot.PCA.object@PCs[,shape.column]
        shape.label = guide_legend(title = stringr::str_to_title(shape.column))
      }
    } else {
      shape.scores = "Samples"
      shape.label = "none"
    }


    if (!is.null(label.column)) {
      if (!(label.column %in% colnames(DEprot.PCA.object@PCs))) {
        return(warning(paste0("The label column '", label.column, "' is not present in the PC analyses table.\n",
                              "Available columns: ", paste0(colnames(DEprot.PCA.object@PCs)[!grepl("^PC", colnames(DEprot.PCA.object@PCs))],
                                                            collapse = ", "))))
      } else {
        show.labels = T
      }
    } else {
      label.column = color.column
      show.labels = F
    }


    ### Build table for plot
    tb = data.frame(PC.x = DEprot.PCA.object@PCs[,paste0("PC",PC.x)],
                    PC.y = DEprot.PCA.object@PCs[,paste0("PC",PC.y)],
                    color = factor(DEprot.PCA.object@PCs[,color.column]),
                    shape = factor(shape.scores),
                    label = DEprot.PCA.object@PCs[,label.column])


    ### Make basic plot
    PCA.plot =
      ggplot(data = tb,
             aes(x = PC.x,
                 y = PC.y,
                 shape = shape,
                 color = color,
                 label = label))

    if (plot.zero.lines == T) {
      PCA.plot =
        PCA.plot +
        geom_vline(xintercept = 0, color = "gray", linetype = 2) +
        geom_hline(yintercept = 0, color = "gray", linetype = 2)
    }

    PCA.plot =
      PCA.plot +
      geom_point(size = 3) +
      theme_classic() +
      xlab(paste0("PC", PC.x, " (", round(DEprot.PCA.object@importance$Percentage.of.Variance[PC.x],1), "%)")) +
      ylab(paste0("PC", PC.y, " (", round(DEprot.PCA.object@importance$Percentage.of.Variance[PC.y],1), "%)")) +
      theme(aspect.ratio = 1,
            axis.line = element_blank(),
            axis.ticks = element_line(color = "black"),
            axis.text = element_text(color = "black"),
            panel.border = element_rect(color = "black", fill = NA))


    ## Add labels
    if (show.labels == T) {
      PCA.plot = PCA.plot + ggrepel::geom_text_repel(max.overlaps = 100,
                                                     show.legend = F)
    }

    PCA.plot =
      PCA.plot +
      guides(color = guide_legend(title = ifelse(color.column == "column.id", yes = "Samples", no = stringr::str_to_title(color.column))),
             shape = shape.label)


    return(PCA.plot)
  }
